---
title: "Estimating the degree to which the methylation profiles resemble either BRAFV600Eor RAS-mutated PTC with the BRAFV600E – RAS score"
author: "Jieqiong Dai"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
      html_document:
        code_folding: hide
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Get the normalized beta data of top 1000 BRAFV600E M vs RAS DM cpg islands (q<=0.01, fold change>=2) in tumor samples
```{r,message=FALSE,warning=FALSE}
# generated by the methlyation DM workflow
load("DM_overlap.Rdata")
library(data.table)
system.time(beta_all <- (fread("normBeta.txt",header=T)))
beta_all <- as.data.frame(beta_all)
rownames(beta_all) <- beta_all $ TargetID
beta_all <- beta_all[,order(colnames(beta_all))]
pheno1 <- read.csv("pheno.csv",row.names=2,header=T)
pheno1 <- subset(pheno1, sample == "T")
pheno1 <- pheno1[rownames(pheno1)%in%colnames(beta_all),]
pheno1 <- pheno1[order(rownames(pheno1)),]
beta <- beta_all[,colnames(beta_all)%in%rownames(pheno1)]
beta <- as.matrix(beta)
colnames(beta)==rownames(pheno1)
top_beta <- beta[rownames(beta)%in%rownames(overlap11[1:min(1000,nrow(overlap11)),]),]
write.csv(top_beta,"top1000_BRAFvsRAS_DMcpg_norBeta_intumor.csv")
```

# Select BRAFV600E mutaion samples
```{r,message=FALSE,warning=FALSE}
pheno_braf <- subset(pheno,BRAF.RAS_Score_Driver.10Jan2020=="BRAF.MutV600E")
top_beta_braf <- top_beta[,colnames(top_beta)%in%rownames(pheno_braf)]
```

# Select RAS mutation samples
```{r,message=FALSE,warning=FALSE}
pheno_ras <- subset(pheno,BRAF.RAS_Score_Driver.10Jan2020=="Mut.RAS")
top_beta_ras <- top_beta[,colnames(top_beta)%in%rownames(pheno_ras)]
```

# Get the centroid of BRAFV600E M and RAS M data
```{r,message=FALSE,warning=FALSE}
CB <- matrix(rowMeans(top_beta_braf),ncol=1, byrow=T)
colnames(CB) <- c("centroid")
rownames(CB) <- rownames(top_beta_braf)

CR <- matrix(rowMeans(top_beta_ras),ncol=1, byrow=T)
colnames(CR) <- c("centroid")
rownames(CR) <- rownames(top_beta_ras)
```

# Get z-score normalized Euclidean distance
```{r,message=FALSE,warning=FALSE}
library(distances)
TB <- lapply(seq(1,ncol(top_beta),by=1),function(i){distances(rbind(t(top_beta[,i]),t(CB)))})
TB <- sapply(TB, function(i){i[1,2]}) 
TB <- (TB-mean(TB))/sd(TB)

TR <- lapply(seq(1,ncol(top_beta),by=1),function(i){distances(rbind(t(top_beta[,i]),t(CR)))})
TR <- sapply(TR, function(i){i[1,2]}) 
TR <- (TR-mean(TR))/sd(TR)
```

# Generate BRAFV600E – RAS score according to the method described in the TCGA analysis

Briefly, we computed the centroids of the top 1000 Mut.BRAFV600E vs Mut.RAS DM cpg island signature in B, c(B), and R, c(R), and for each tumor t we defined the BRAFV600E-RAS score (BRS) of t as the difference between the distance of t from c(B) and c(R):
BRS(t) = |v(t)-c(B)|2 - |v(t)-c(R)|2
where v(t) is the vector of normalized beta values of the top 1000 DM cpg islands in t, and the distance |x-y|2 is the normalized Euclidean distance between the vectors.
Tumors with negative BRS (closer to B than to R) were defined BRAFV600E-like, while tumors with positive BRS (closer to R than to B) were defined RAS-like.
```{r,message=FALSE,warning=FALSE}
BRS <- TB-TR
BRS <- matrix(BRS,ncol=1, byrow=T)
colnames(BRS) <- c("BRS")
rownames(BRS) <- colnames(top_beta)  
write.csv(BRS,"tumor_BRS_meth.csv")
BRS
```

